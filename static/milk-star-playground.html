<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Milk Star Calculator Explorer</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #1a1a2e;
    --surface: #16213e;
    --surface2: #0f3460;
    --accent: #e94560;
    --accent2: #f5c518;
    --text: #e0e0e0;
    --text-dim: #8888aa;
    --green: #4ade80;
    --red: #f87171;
    --border: #2a2a4a;
  }
  body {
    font-family: system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }
  .layout {
    display: grid;
    grid-template-columns: 340px 1fr;
    grid-template-rows: auto 1fr auto;
    min-height: 100vh;
  }
  header {
    grid-column: 1 / -1;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 12px 20px;
    display: flex;
    align-items: center;
    gap: 16px;
  }
  header h1 {
    font-size: 18px;
    font-weight: 600;
    color: var(--accent2);
  }
  header .subtitle {
    font-size: 13px;
    color: var(--text-dim);
  }

  /* Controls panel */
  .controls {
    background: var(--surface);
    border-right: 1px solid var(--border);
    padding: 16px;
    overflow-y: auto;
    grid-row: 2 / 4;
  }
  .control-group {
    margin-bottom: 20px;
  }
  .control-group h3 {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    margin-bottom: 10px;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--border);
  }
  label {
    display: block;
    font-size: 13px;
    margin-bottom: 4px;
    color: var(--text-dim);
  }
  select, input[type="number"], input[type="range"] {
    width: 100%;
    padding: 6px 8px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    color: var(--text);
    font-size: 13px;
    margin-bottom: 10px;
  }
  select:focus, input:focus {
    outline: none;
    border-color: var(--accent);
  }
  input[type="range"] {
    padding: 0;
    height: 6px;
    -webkit-appearance: none;
    appearance: none;
    border: none;
    border-radius: 3px;
    background: var(--border);
    cursor: pointer;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px; height: 16px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
  }
  .range-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
  }
  .range-row input[type="range"] {
    flex: 1;
    margin-bottom: 0;
  }
  .range-value {
    font-size: 13px;
    font-family: 'SF Mono', 'Menlo', monospace;
    color: var(--accent2);
    min-width: 60px;
    text-align: right;
  }

  /* Presets */
  .presets {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 10px;
  }
  .preset-btn {
    padding: 4px 10px;
    font-size: 11px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    color: var(--text);
    cursor: pointer;
    transition: all 0.15s;
  }
  .preset-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }
  .preset-btn.active {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }

  /* Toggle */
  .toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  .toggle-row label {
    margin-bottom: 0;
  }
  .toggle {
    width: 36px;
    height: 20px;
    background: var(--border);
    border-radius: 10px;
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
  }
  .toggle.on { background: var(--accent); }
  .toggle::after {
    content: '';
    width: 16px; height: 16px;
    background: white;
    border-radius: 50%;
    position: absolute;
    top: 2px;
    left: 2px;
    transition: left 0.2s;
  }
  .toggle.on::after { left: 18px; }

  /* Preview panel */
  .preview {
    padding: 24px;
    overflow-y: auto;
  }

  /* Result card */
  .result-card {
    background: var(--surface);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 20px;
    border: 1px solid var(--border);
  }
  .designation-display {
    text-align: center;
    padding: 20px 0;
  }
  .designation-text {
    font-size: 48px;
    font-weight: 800;
    font-family: 'SF Mono', 'Menlo', monospace;
  }
  .designation-text.qualifies { color: var(--accent2); }
  .designation-text.no-qualify { color: var(--text-dim); }
  .designation-label {
    font-size: 14px;
    color: var(--text-dim);
    margin-top: 4px;
  }
  .method-badge {
    display: inline-block;
    padding: 2px 10px;
    border-radius: 10px;
    font-size: 11px;
    margin-top: 8px;
  }
  .method-production { background: #065f46; color: #6ee7b7; }
  .method-none { background: #44403c; color: #a8a29e; }

  /* Component bars */
  .component-row {
    margin-bottom: 14px;
  }
  .component-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
  }
  .component-name {
    font-size: 13px;
    font-weight: 600;
  }
  .component-values {
    font-size: 12px;
    font-family: 'SF Mono', 'Menlo', monospace;
  }
  .bar-bg {
    height: 24px;
    background: var(--bg);
    border-radius: 4px;
    position: relative;
    overflow: visible;
    margin-top: 18px;
  }
  .bar-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s ease, background 0.3s;
    position: absolute;
    top: 0;
    left: 0;
  }
  .bar-fill.pass { background: linear-gradient(90deg, #065f46, #059669); }
  .bar-fill.fail { background: linear-gradient(90deg, #7f1d1d, #dc2626); }
  .bar-threshold {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--accent2);
    z-index: 2;
  }
  .bar-threshold-label {
    position: absolute;
    top: -16px;
    font-size: 10px;
    color: var(--accent2);
    font-family: 'SF Mono', 'Menlo', monospace;
    transform: translateX(-50%);
    white-space: nowrap;
  }
  .qualify-icon {
    font-size: 14px;
    margin-left: 6px;
  }
  .qualify-icon.pass { color: var(--green); }
  .qualify-icon.fail { color: var(--red); }

  /* Minimums table */
  .minimums-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-top: 12px;
  }
  .minimums-table th {
    text-align: left;
    padding: 6px 8px;
    color: var(--text-dim);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--border);
  }
  .minimums-table td {
    padding: 6px 8px;
    font-family: 'SF Mono', 'Menlo', monospace;
    border-bottom: 1px solid rgba(42,42,74,0.5);
  }

  /* Generation chain */
  .gen-chain {
    display: flex;
    align-items: center;
    gap: 4px;
    justify-content: center;
    margin-top: 12px;
    flex-wrap: wrap;
  }
  .gen-node {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-family: 'SF Mono', 'Menlo', monospace;
    border: 1px solid var(--border);
  }
  .gen-node.active { background: var(--accent); border-color: var(--accent); color: white; }
  .gen-node.ancestor { background: var(--surface2); border-color: var(--surface2); }
  .gen-arrow { color: var(--text-dim); font-size: 14px; }

  /* Prompt section */
  .prompt-section {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    background: var(--surface);
  }
  .prompt-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  .prompt-header h3 {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
  }
  .copy-btn {
    padding: 4px 12px;
    font-size: 12px;
    background: var(--accent);
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    transition: background 0.15s;
  }
  .copy-btn:hover { background: #c7374d; }
  .copy-btn.copied { background: var(--green); color: #000; }
  .prompt-text {
    font-family: 'SF Mono', 'Menlo', monospace;
    font-size: 12px;
    line-height: 1.6;
    color: var(--text);
    background: var(--bg);
    padding: 12px;
    border-radius: 6px;
    white-space: pre-wrap;
    max-height: 120px;
    overflow-y: auto;
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 0;
    margin-bottom: 10px;
  }
  .tab {
    padding: 8px 16px;
    font-size: 13px;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-dim);
    cursor: pointer;
    transition: all 0.15s;
  }
  .tab:first-child { border-radius: 6px 0 0 6px; }
  .tab:last-child { border-radius: 0 6px 6px 0; }
  .tab.active {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }
  .tab:hover:not(.active) { color: var(--text); }

  .path-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 0;
    font-size: 13px;
    border-bottom: 1px solid rgba(42,42,74,0.3);
  }
  .path-letter {
    font-family: 'SF Mono', 'Menlo', monospace;
    font-weight: 700;
    color: var(--accent2);
    min-width: 20px;
  }
  .path-status { min-width: 18px; text-align: center; }
  .card-title { font-size: 14px; margin-bottom: 12px; color: var(--text-dim); }
  .card-note { font-size: 11px; color: var(--text-dim); margin-top: 10px; }
  .pedigree-box {
    flex: 1; min-width: 140px; padding: 12px;
    background: var(--bg); border-radius: 6px;
  }
  .pedigree-box-label { font-size: 11px; color: var(--text-dim); }
  .pedigree-box-value { font-size: 13px; margin-top: 4px; }

  @media (max-width: 800px) {
    .layout { grid-template-columns: 1fr; }
    .controls { grid-row: auto; border-right: none; border-bottom: 1px solid var(--border); }
  }
</style>
</head>
<body>

<div class="layout">
  <header>
    <h1>ADGA Milk Star Explorer</h1>
    <span class="subtitle">Visualize how star designations (*M, *B, +B) are determined</span>
  </header>

  <div class="controls">
    <div class="control-group">
      <h3>Presets</h3>
      <div class="presets" id="presets"></div>
    </div>

    <div class="control-group">
      <h3>Animal</h3>
      <div class="tabs" id="sex-tabs">
        <div class="tab active" data-val="doe" onclick="setSex('doe')">Doe (*M)</div>
        <div class="tab" data-val="buck" onclick="setSex('buck')">Buck (*B/+B)</div>
      </div>
    </div>

    <div class="control-group">
      <h3>Breed Size</h3>
      <div class="tabs" id="breed-tabs">
        <div class="tab active" data-val="standard" onclick="setBreed('standard')">Standard</div>
        <div class="tab" data-val="miniature" onclick="setBreed('miniature')">Miniature (ND)</div>
      </div>
    </div>

    <div class="control-group" id="age-group">
      <h3>Age at Freshening</h3>
      <label>Age (days)</label>
      <div class="range-row">
        <input type="range" id="age-slider" min="365" max="2555" value="912"
          oninput="state.ageDays=+this.value; updateAll()">
        <span class="range-value" id="age-display">2y 6m</span>
      </div>
    </div>

    <div class="control-group" id="production-group">
      <h3>Lactation Production</h3>
      <label>Milk (lbs)</label>
      <div class="range-row">
        <input type="range" id="milk-slider" min="0" max="5000" value="1800" step="10"
          oninput="state.milk=+this.value; updateAll()">
        <span class="range-value" id="milk-display">1800</span>
      </div>
      <label>Butterfat (lbs)</label>
      <div class="range-row">
        <input type="range" id="fat-slider" min="0" max="200" value="60" step="0.5"
          oninput="state.fat=+this.value; updateAll()">
        <span class="range-value" id="fat-display">60.0</span>
      </div>
      <label>Protein (lbs)</label>
      <div class="range-row">
        <input type="range" id="protein-slider" min="0" max="200" value="50" step="0.5"
          oninput="state.protein=+this.value; updateAll()">
        <span class="range-value" id="protein-display">50.0</span>
      </div>
    </div>

    <div class="control-group" id="dam-group">
      <h3>Maternal Line</h3>
      <label>Dam's Star Count</label>
      <div class="range-row">
        <input type="range" id="dam-slider" min="0" max="10" value="0"
          oninput="state.damStars=+this.value; updateAll()">
        <span class="range-value" id="dam-display">0</span>
      </div>
    </div>

    <div class="control-group" id="buck-pedigree-group" style="display:none">
      <h3>Pedigree (*B)</h3>
      <div class="toggle-row">
        <label>Dam qualifies (milk + fat)</label>
        <div class="toggle" id="dam-qual-toggle" onclick="toggleDamQual()"></div>
      </div>
      <div class="toggle-row">
        <label>Sire is AR/*B/+B</label>
        <div class="toggle" id="sire-qual-toggle" onclick="toggleSireQual()"></div>
      </div>
      <div class="toggle-row">
        <label>Sire's dam qualifies (milk + fat)</label>
        <div class="toggle" id="sires-dam-toggle" onclick="toggleSiresDam()"></div>
      </div>
    </div>

    <div class="control-group" id="buck-progeny-group" style="display:none">
      <h3>Progeny (+B)</h3>
      <label>*M Daughters (from different dams)</label>
      <div class="range-row">
        <input type="range" id="daughters-slider" min="0" max="10" value="0"
          oninput="state.daughters=+this.value; updateAll()">
        <span class="range-value" id="daughters-display">0</span>
      </div>
      <label>AR Sons</label>
      <div class="range-row">
        <input type="range" id="ar-sons-slider" min="0" max="5" value="0"
          oninput="state.arSons=+this.value; updateAll()">
        <span class="range-value" id="ar-sons-display">0</span>
      </div>
      <label>+B Sons</label>
      <div class="range-row">
        <input type="range" id="plus-b-sons-slider" min="0" max="5" value="0"
          oninput="state.plusBSons=+this.value; updateAll()">
        <span class="range-value" id="plus-b-sons-display">0</span>
      </div>
    </div>
  </div>

  <div class="preview" id="preview"></div>

  <div class="prompt-section">
    <div class="prompt-header">
      <h3>Prompt Output</h3>
      <button class="copy-btn" id="copy-btn" onclick="copyPrompt()">Copy</button>
    </div>
    <div class="prompt-text" id="prompt-output"></div>
  </div>
</div>

<script>
const STANDARD_BASE = { milk: 1500, butterfat: 52.50, protein: 45.00 };
const STANDARD_INC  = { milk: 0.2,  butterfat: 0.007, protein: 0.006 };
const MINIATURE_BASE = { milk: 600, butterfat: 31.00, protein: 18.00 };
const MINIATURE_INC  = { milk: 0.08, butterfat: 0.0028, protein: 0.0024 };
const TWO_YEARS = 730;
const FIVE_YEARS = 1826;

const state = {
  sex: 'doe', breed: 'standard', ageDays: 912,
  milk: 1800, fat: 60, protein: 50, damStars: 0,
  damQualifies: false, sireQualifies: false, siresDamQualifies: false,
  daughters: 0, arSons: 0, plusBSons: 0,
};

const PRESETS = [
  { name: 'First Freshener', desc: 'Young doe, first lactation, barely qualifying',
    values: { sex:'doe', breed:'standard', ageDays:730, milk:1510, fat:53, protein:44, damStars:0 } },
  { name: '3*M Champion', desc: 'High-producing doe with 2*M dam',
    values: { sex:'doe', breed:'standard', ageDays:1095, milk:2800, fat:95, protein:80, damStars:2 } },
  { name: 'Nigerian Dwarf', desc: 'Miniature breed with lower thresholds',
    values: { sex:'doe', breed:'miniature', ageDays:912, milk:700, fat:35, protein:20, damStars:0 } },
  { name: 'Near Miss', desc: 'Close but does not qualify on any component',
    values: { sex:'doe', breed:'standard', ageDays:912, milk:1490, fat:51, protein:44, damStars:0 } },
  { name: '*B Buck', desc: 'Buck with qualifying dam and sire',
    values: { sex:'buck', breed:'standard', ageDays:912, damQualifies:true, sireQualifies:true, siresDamQualifies:false, daughters:0, arSons:0, plusBSons:0 } },
  { name: '+B Buck', desc: 'Buck qualifying via 3 *M daughters',
    values: { sex:'buck', breed:'standard', ageDays:912, damQualifies:false, sireQualifies:false, siresDamQualifies:false, daughters:3, arSons:0, plusBSons:0 } },
];

function computeMinimum(ageDays, breed, component) {
  const base = breed === 'miniature' ? MINIATURE_BASE : STANDARD_BASE;
  const inc  = breed === 'miniature' ? MINIATURE_INC  : STANDARD_INC;
  const daysOver2 = Math.min(Math.max(0, ageDays - TWO_YEARS), FIVE_YEARS - TWO_YEARS);
  return base[component] + daysOver2 * inc[component];
}

function evaluateDoe() {
  const components = ['milk', 'butterfat', 'protein'];
  const actuals = { milk: state.milk, butterfat: state.fat, protein: state.protein };
  const results = components.map(c => {
    const min = computeMinimum(state.ageDays, state.breed, c);
    return { component: c, actual: actuals[c], minimum: min, qualifies: actuals[c] >= min };
  });
  const anyQualifies = results.some(r => r.qualifies);
  const genCount = anyQualifies ? state.damStars + 1 : 0;
  const designation = anyQualifies ? genCount + '*M' : '';
  return { results, anyQualifies, genCount, designation };
}

function evaluateBuck() {
  let starB = false, starBDesc = '';
  if (state.damQualifies) {
    if (state.sireQualifies) { starB = true; starBDesc = 'Dam qualifies (milk+fat) and sire is qualified'; }
    else if (state.siresDamQualifies) { starB = true; starBDesc = 'Dam qualifies (milk+fat) and sire\'s dam qualifies (milk+fat)'; }
  }
  const paths = [
    { letter: 'A', desc: '3 *M daughters from 3 different dams', met: state.daughters >= 3 },
    { letter: 'B', desc: '2 +B sons', met: state.plusBSons >= 2 },
    { letter: 'C', desc: '1 AR son + 1 +B son', met: state.arSons >= 1 && state.plusBSons >= 1 },
    { letter: 'D', desc: '1 AR son + 2 qualifying daughters', met: state.arSons >= 1 && state.daughters >= 2 },
    { letter: 'E', desc: '1 +B son + 2 qualifying daughters', met: state.plusBSons >= 1 && state.daughters >= 2 },
  ];
  const plusB = paths.some(p => p.met);
  const firstPath = paths.find(p => p.met);
  let designation = '';
  if (plusB) designation = '+B';
  else if (starB) designation = '*B';
  return { starB, starBDesc, plusB, firstPath, paths, designation };
}

function formatAge(days) {
  const y = Math.floor(days / 365);
  const m = Math.floor((days % 365) / 30);
  return y + 'y ' + m + 'm';
}

function escapeText(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function renderPreview() {
  const preview = document.getElementById('preview');

  // Build DOM safely
  while (preview.firstChild) preview.removeChild(preview.firstChild);

  if (state.sex === 'doe') {
    const eval_ = evaluateDoe();
    const compNames = { milk: 'Milk', butterfat: 'Butterfat', protein: 'Protein' };

    // Designation card
    const card1 = document.createElement('div');
    card1.className = 'result-card';

    const desigDiv = document.createElement('div');
    desigDiv.className = 'designation-display';

    const desigText = document.createElement('div');
    desigText.className = 'designation-text ' + (eval_.anyQualifies ? 'qualifies' : 'no-qualify');
    desigText.textContent = eval_.designation || 'No Star';
    desigDiv.appendChild(desigText);

    const desigLabel = document.createElement('div');
    desigLabel.className = 'designation-label';
    desigLabel.textContent = eval_.anyQualifies
      ? 'Qualifies via own production \u2014 ' + eval_.genCount + ' consecutive generation' + (eval_.genCount > 1 ? 's' : '')
      : 'Does not meet minimum requirements';
    desigDiv.appendChild(desigLabel);

    const badge = document.createElement('span');
    badge.className = 'method-badge ' + (eval_.anyQualifies ? 'method-production' : 'method-none');
    badge.textContent = eval_.anyQualifies ? 'Production' : 'Not Qualified';
    desigDiv.appendChild(badge);

    card1.appendChild(desigDiv);

    // Generation chain
    if (eval_.anyQualifies && eval_.genCount > 0) {
      const chain = document.createElement('div');
      chain.className = 'gen-chain';
      for (let i = eval_.genCount; i >= 1; i--) {
        if (i < eval_.genCount) {
          const arrow = document.createElement('span');
          arrow.className = 'gen-arrow';
          arrow.innerHTML = '&larr;';
          chain.appendChild(arrow);
        }
        const node = document.createElement('span');
        node.className = 'gen-node ' + (i === eval_.genCount ? 'active' : 'ancestor');
        let label = i + '*M ';
        if (i === eval_.genCount) label += '(this doe)';
        else {
          const depth = eval_.genCount - i;
          label += '(' + (depth === 1 ? 'dam' : 'great-'.repeat(depth - 2) + (depth > 1 ? 'grand' : '') + 'dam') + ')';
        }
        node.textContent = label;
        chain.appendChild(node);
      }
      card1.appendChild(chain);
    }

    preview.appendChild(card1);

    // Component evaluation card
    const card2 = document.createElement('div');
    card2.className = 'result-card';

    const title2 = document.createElement('h3');
    title2.className = 'card-title';
    title2.textContent = 'Component Evaluation at ' + formatAge(state.ageDays);
    card2.appendChild(title2);

    eval_.results.forEach(r => {
      const row = document.createElement('div');
      row.className = 'component-row';

      const hdr = document.createElement('div');
      hdr.className = 'component-header';

      const nameSpan = document.createElement('span');
      nameSpan.className = 'component-name';
      nameSpan.textContent = compNames[r.component] + ' ';
      const icon = document.createElement('span');
      icon.className = 'qualify-icon ' + (r.qualifies ? 'pass' : 'fail');
      icon.textContent = r.qualifies ? '\u2713' : '\u2717';
      nameSpan.appendChild(icon);
      hdr.appendChild(nameSpan);

      const valSpan = document.createElement('span');
      valSpan.className = 'component-values';
      valSpan.textContent = r.actual.toFixed(1) + ' / ' + r.minimum.toFixed(2) + ' lbs';
      hdr.appendChild(valSpan);

      row.appendChild(hdr);

      const barBg = document.createElement('div');
      barBg.className = 'bar-bg';

      const barFill = document.createElement('div');
      barFill.className = 'bar-fill ' + (r.qualifies ? 'pass' : 'fail');
      const barMax = Math.max(r.actual, r.minimum) * 1.25;
      const pct = Math.min(100, (r.actual / barMax) * 100);
      barFill.style.width = pct + '%';
      barBg.appendChild(barFill);

      const thresh = document.createElement('div');
      thresh.className = 'bar-threshold';
      const threshPct = Math.min(100, (r.minimum / barMax) * 100);
      thresh.style.left = threshPct + '%';

      const threshLabel = document.createElement('span');
      threshLabel.className = 'bar-threshold-label';
      threshLabel.textContent = 'min ' + r.minimum.toFixed(1);
      thresh.appendChild(threshLabel);

      barBg.appendChild(thresh);
      row.appendChild(barBg);
      card2.appendChild(row);
    });

    const note2 = document.createElement('p');
    note2.className = 'card-note';
    note2.textContent = 'Doe needs ANY one component to meet its minimum for *M qualification.';
    card2.appendChild(note2);

    preview.appendChild(card2);

    // Minimums table card
    const card3 = document.createElement('div');
    card3.className = 'result-card';

    const title3 = document.createElement('h3');
    title3.className = 'card-title';
    title3.textContent = 'Minimum Requirements by Age (' + (state.breed === 'miniature' ? 'Nigerian Dwarf' : 'Standard Breed') + ')';
    card3.appendChild(title3);

    const table = document.createElement('table');
    table.className = 'minimums-table';

    const thead = document.createElement('tr');
    ['Age', 'Milk (lbs)', 'Fat (lbs)', 'Protein (lbs)'].forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      thead.appendChild(th);
    });
    table.appendChild(thead);

    [730, 912, 1095, 1460, 1826].forEach(a => {
      const tr = document.createElement('tr');
      if (Math.abs(a - state.ageDays) < 30) tr.style.background = 'rgba(233,69,96,0.15)';
      [formatAge(a),
       computeMinimum(a, state.breed, 'milk').toFixed(1),
       computeMinimum(a, state.breed, 'butterfat').toFixed(2),
       computeMinimum(a, state.breed, 'protein').toFixed(2)
      ].forEach(v => {
        const td = document.createElement('td');
        td.textContent = v;
        tr.appendChild(td);
      });
      table.appendChild(tr);
    });
    card3.appendChild(table);

    const note3 = document.createElement('p');
    note3.className = 'card-note';
    note3.textContent = 'Minimums increase linearly from 2y to 5y, then cap.';
    card3.appendChild(note3);

    preview.appendChild(card3);

  } else {
    // Buck view
    const eval_ = evaluateBuck();

    // Designation card
    const card1 = document.createElement('div');
    card1.className = 'result-card';

    const desigDiv = document.createElement('div');
    desigDiv.className = 'designation-display';

    const desigText = document.createElement('div');
    desigText.className = 'designation-text ' + (eval_.designation ? 'qualifies' : 'no-qualify');
    desigText.textContent = eval_.designation || 'No Star';
    desigDiv.appendChild(desigText);

    const desigLabel = document.createElement('div');
    desigLabel.className = 'designation-label';
    desigLabel.textContent = eval_.designation === '+B' ? 'Qualifies via progeny'
      : eval_.designation === '*B' ? 'Qualifies via pedigree'
      : 'Does not meet requirements for *B or +B';
    desigDiv.appendChild(desigLabel);

    if (eval_.starB) {
      const b1 = document.createElement('span');
      b1.className = 'method-badge method-production';
      b1.textContent = '*B Pedigree';
      desigDiv.appendChild(b1);
    }
    if (eval_.plusB) {
      const b2 = document.createElement('span');
      b2.className = 'method-badge';
      b2.style.cssText = 'background:#1e3a5f;color:#93c5fd;margin-left:4px';
      b2.textContent = '+B Progeny';
      desigDiv.appendChild(b2);
    }
    if (!eval_.designation) {
      const b3 = document.createElement('span');
      b3.className = 'method-badge method-none';
      b3.textContent = 'Not Qualified';
      desigDiv.appendChild(b3);
    }

    card1.appendChild(desigDiv);
    preview.appendChild(card1);

    // *B Pedigree card
    const card2 = document.createElement('div');
    card2.className = 'result-card';

    const title2 = document.createElement('h3');
    title2.className = 'card-title';
    title2.textContent = '*B \u2014 Pedigree Qualification';
    card2.appendChild(title2);

    const boxes = document.createElement('div');
    boxes.style.cssText = 'display:flex;gap:12px;flex-wrap:wrap;margin-top:12px';

    const pedigreeData = [
      { label: 'Dam', qual: state.damQualifies, yes: 'Qualifies (milk+fat)', no: 'Not qualified' },
      { label: 'Sire', qual: state.sireQualifies, yes: 'AR/*B/+B', no: 'Not qualified' },
      { label: "Sire's Dam", qual: state.siresDamQualifies, yes: 'Qualifies (milk+fat)', no: 'Not qualified' },
    ];
    pedigreeData.forEach(d => {
      const box = document.createElement('div');
      box.className = 'pedigree-box';
      box.style.borderWidth = '1px';
      box.style.borderStyle = 'solid';
      box.style.borderColor = d.qual ? 'var(--green)' : 'var(--border)';

      const lbl = document.createElement('div');
      lbl.className = 'pedigree-box-label';
      lbl.textContent = d.label;
      box.appendChild(lbl);

      const val = document.createElement('div');
      val.className = 'pedigree-box-value';
      val.style.color = d.qual ? 'var(--green)' : 'var(--red)';
      val.textContent = d.qual ? d.yes : d.no;
      box.appendChild(val);

      boxes.appendChild(box);
    });
    card2.appendChild(boxes);

    const note2 = document.createElement('p');
    note2.className = 'card-note';
    note2.textContent = '*B requires: dam qualifies on milk+fat AND (sire is AR/*B/+B OR sire\'s dam qualifies on milk+fat)';
    card2.appendChild(note2);

    preview.appendChild(card2);

    // +B Progeny card
    const card3 = document.createElement('div');
    card3.className = 'result-card';

    const title3 = document.createElement('h3');
    title3.className = 'card-title';
    title3.textContent = '+B \u2014 Progeny Qualification Paths';
    card3.appendChild(title3);

    const pathNote = document.createElement('div');
    pathNote.style.cssText = 'font-size:12px;color:var(--text-dim);margin-bottom:8px';
    pathNote.textContent = 'Any one path is sufficient';
    card3.appendChild(pathNote);

    eval_.paths.forEach(p => {
      const row = document.createElement('div');
      row.className = 'path-row';

      const letter = document.createElement('span');
      letter.className = 'path-letter';
      letter.textContent = p.letter;
      row.appendChild(letter);

      const status = document.createElement('span');
      status.className = 'path-status';
      status.style.color = p.met ? 'var(--green)' : 'var(--text-dim)';
      status.textContent = p.met ? '\u2713' : '\u2014';
      row.appendChild(status);

      const desc = document.createElement('span');
      desc.textContent = p.desc;
      row.appendChild(desc);

      card3.appendChild(row);
    });

    preview.appendChild(card3);
  }
}

function updatePrompt() {
  const el = document.getElementById('prompt-output');
  const parts = [];

  if (state.sex === 'doe') {
    const eval_ = evaluateDoe();
    const breedLabel = state.breed === 'miniature' ? 'Nigerian Dwarf' : 'standard breed';
    parts.push('A ' + breedLabel + ' doe freshening at ' + formatAge(state.ageDays) + ' old');
    parts.push('produced ' + state.milk + ' lbs milk, ' + state.fat + ' lbs butterfat, and ' + state.protein + ' lbs protein in a single lactation.');

    const minMilk = computeMinimum(state.ageDays, state.breed, 'milk');
    const minFat = computeMinimum(state.ageDays, state.breed, 'butterfat');
    const minPro = computeMinimum(state.ageDays, state.breed, 'protein');
    parts.push('\nMinimums at this age: ' + minMilk.toFixed(1) + ' lbs milk, ' + minFat.toFixed(2) + ' lbs fat, ' + minPro.toFixed(2) + ' lbs protein.');

    const qualified = eval_.results.filter(r => r.qualifies).map(r => r.component);
    const failed = eval_.results.filter(r => !r.qualifies).map(r => r.component + ' (' + r.actual.toFixed(1) + ' vs ' + r.minimum.toFixed(1) + ' needed)');

    if (eval_.anyQualifies) {
      parts.push('Qualifies on: ' + qualified.join(', ') + '.');
      if (failed.length) parts.push('Does not meet: ' + failed.join(', ') + '.');
      parts.push('\nWith ' + (state.damStars > 0 ? 'a ' + state.damStars + '*M dam' : 'no starred dam') + ', this doe earns ' + eval_.designation + '.');
    } else {
      parts.push('\nDoes not qualify. Shortfalls: ' + failed.join('; ') + '.');
    }
  } else {
    const eval_ = evaluateBuck();
    parts.push('A ' + (state.breed === 'miniature' ? 'Nigerian Dwarf' : 'standard breed') + ' buck.');

    if (eval_.starB) {
      parts.push('\n*B: ' + eval_.starBDesc + '.');
    } else {
      const reasons = [];
      if (!state.damQualifies) reasons.push('dam does not qualify on milk+fat');
      else {
        if (!state.sireQualifies) reasons.push('sire is not AR/*B/+B');
        if (!state.siresDamQualifies) reasons.push("sire's dam does not qualify on milk+fat");
      }
      parts.push('\n*B: Not qualified (' + reasons.join('; ') + ').');
    }

    if (eval_.plusB) {
      parts.push('+B: Qualifies via Path ' + eval_.firstPath.letter + ' (' + eval_.firstPath.desc + ').');
    } else {
      parts.push('+B: Not qualified. Has ' + state.daughters + ' *M daughters, ' + state.arSons + ' AR sons, ' + state.plusBSons + ' +B sons.');
    }

    parts.push('\nDesignation: ' + (eval_.designation || 'None') + '.');
  }

  el.textContent = parts.join('\n');
}

function updateAll() {
  document.getElementById('age-display').textContent = formatAge(state.ageDays);
  document.getElementById('milk-display').textContent = state.milk;
  document.getElementById('fat-display').textContent = state.fat.toFixed(1);
  document.getElementById('protein-display').textContent = state.protein.toFixed(1);
  document.getElementById('dam-display').textContent = state.damStars;
  document.getElementById('daughters-display').textContent = state.daughters;
  document.getElementById('ar-sons-display').textContent = state.arSons;
  document.getElementById('plus-b-sons-display').textContent = state.plusBSons;

  document.getElementById('age-slider').value = state.ageDays;
  document.getElementById('milk-slider').value = state.milk;
  document.getElementById('fat-slider').value = state.fat;
  document.getElementById('protein-slider').value = state.protein;
  document.getElementById('dam-slider').value = state.damStars;
  document.getElementById('daughters-slider').value = state.daughters;
  document.getElementById('ar-sons-slider').value = state.arSons;
  document.getElementById('plus-b-sons-slider').value = state.plusBSons;

  const isDoe = state.sex === 'doe';
  document.getElementById('production-group').style.display = isDoe ? '' : 'none';
  document.getElementById('dam-group').style.display = isDoe ? '' : 'none';
  document.getElementById('age-group').style.display = isDoe ? '' : 'none';
  document.getElementById('buck-pedigree-group').style.display = isDoe ? 'none' : '';
  document.getElementById('buck-progeny-group').style.display = isDoe ? 'none' : '';

  document.getElementById('dam-qual-toggle').className = 'toggle' + (state.damQualifies ? ' on' : '');
  document.getElementById('sire-qual-toggle').className = 'toggle' + (state.sireQualifies ? ' on' : '');
  document.getElementById('sires-dam-toggle').className = 'toggle' + (state.siresDamQualifies ? ' on' : '');

  document.querySelectorAll('#sex-tabs .tab').forEach(t => t.classList.toggle('active', t.dataset.val === state.sex));
  document.querySelectorAll('#breed-tabs .tab').forEach(t => t.classList.toggle('active', t.dataset.val === state.breed));

  if (state.breed === 'miniature') {
    document.getElementById('milk-slider').max = 2000;
    document.getElementById('fat-slider').max = 100;
    document.getElementById('protein-slider').max = 80;
  } else {
    document.getElementById('milk-slider').max = 5000;
    document.getElementById('fat-slider').max = 200;
    document.getElementById('protein-slider').max = 200;
  }

  renderPreview();
  updatePrompt();
}

function setSex(s) { state.sex = s; updateAll(); }
function setBreed(b) { state.breed = b; updateAll(); }
function toggleDamQual() { state.damQualifies = !state.damQualifies; updateAll(); }
function toggleSireQual() { state.sireQualifies = !state.sireQualifies; updateAll(); }
function toggleSiresDam() { state.siresDamQualifies = !state.siresDamQualifies; updateAll(); }

function applyPreset(idx) {
  Object.assign(state, PRESETS[idx].values);
  document.querySelectorAll('.preset-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
  updateAll();
}

function copyPrompt() {
  const text = document.getElementById('prompt-output').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('copy-btn');
    btn.textContent = 'Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 1500);
  });
}

// Init presets
(function() {
  const container = document.getElementById('presets');
  PRESETS.forEach((p, i) => {
    const btn = document.createElement('button');
    btn.className = 'preset-btn';
    btn.textContent = p.name;
    btn.title = p.desc;
    btn.addEventListener('click', () => applyPreset(i));
    container.appendChild(btn);
  });
})();

updateAll();
</script>
</body>
</html>
